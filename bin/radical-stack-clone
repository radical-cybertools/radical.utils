#!/bin/sh

# this script expects the output of `radical-stack` as input file (first
# argument), and will then create a respective virtualenv in the given location
# (second argtument)

# ------------------------------------------------------------------------------
#
tmp="/tmp/radical-stack-tmp.$(id -u)"
stack=$1
ve_target=$2
cwd=`pwd`
log="$stack.log"

# ------------------------------------------------------------------------------
#
usage() {
    msg=$1
    echo "\n\t$msg\n\tusage: $0 <stack> <ve_target>\n\n"
    exit
}

# ------------------------------------------------------------------------------
#
install() {

    mod="$1"
    info="$2"

    repo="git@github.com:radical-cybertools/$mod.git"

    spec=$(  echo "$info" | cut -f 2 -d ':' | xargs echo)
    branch=$(echo "$spec" | cut -f 2 -d '@' | tr '-' '/')
    commit=$(echo "$spec" | sed -e 's/.*-g\([a-zA-Z0-9]*\)@.*/\1/g')
    tag=$(   echo "$spec" | cut -f 1 -d '-')

    printf "%-20s  %-55s  %-30s %-30s %s\n" "$mod" "$repo" "$branch" "$commit" "$tag"

    if ! test -d "$tmp/$repo"
    then
        git clone $repo $tmp/$repo 2>&1 >> $log
    fi

    cd $tmp/$repo
    git pull --all        >> $log 2>&1
    git checkout $branch  >> $log 2>&1
    git checkout $commit  >> $log 2>&1
    pip uninstall -y $mod >> $log 2>&1
    pip install .         >> $log 2>&1
    cd $cwd
}


# ------------------------------------------------------------------------------
#
if test -z "$stack"
then
    usage 'missing input stack'
fi

if test -z "$ve_target"
then
    usage 'missing target ve'
fi

if ! test -d "$ve_target"
then
    echo "create   $ve_target"
    virtualenv    "$ve_target" >> $log 2>&1
fi

. "$ve_target/bin/activate"

printf "%-20s  %-55s  %-30s %-30s %s\n" "mod" "repo" "branch" "commit" "tag"

for mod in 'radical.utils' 'saga-python' 'radical.pilot' 'radical.analytics'
do
    ru_info=$(cat $stack | grep -e "^$mod" | tail -n 1)
    if test -z "$ru_info"
    then
        echo "skip $mod"
    else
        install "$mod" "$ru_info"
    fi
done

cd $cwd

# verify
echo '---------------'
cat $stack | grep ':'
echo '---------------'
$ve_target/bin/python `which radical-stack`
echo '---------------'

# ------------------------------------------------------------------------------

